name: Aggregate Documentation

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 */6 * * *'
  repository_dispatch:
    types: [docs-update]
  workflow_dispatch:

concurrency:
  group: docs-aggregation
  cancel-in-progress: false

jobs:
  aggregate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout nono-docs
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.DOCS_PAT }}
          fetch-depth: 0
          path: base

      - name: Clone sub-repos
        env:
          GH_TOKEN: ${{ secrets.DOCS_PAT }}
        run: |
          git clone --depth 1 https://x-access-token:${GH_TOKEN}@github.com/always-further/nono.git nono
          git clone --depth 1 https://x-access-token:${GH_TOKEN}@github.com/always-further/nono-py.git nono-py
          git clone --depth 1 https://x-access-token:${GH_TOKEN}@github.com/always-further/nono-ts.git nono-ts

      - name: Aggregate docs and merge navigation
        run: |
          mkdir -p output

          # Copy base docs (introduction, quickstart, core, logo, etc.)
          cp -r base/docs/* output/

          # Copy content from sub-repos
          cp -r nono/docs/cli output/
          cp -r nono/docs/assets output/
          cp -r nono-py/docs/python output/
          cp -r nono-ts/docs/typescript output/

          # Merge navigation from sub-repo docs.json into base docs.json
          # Each sub-repo's navigation.groups replaces the matching tab in the base config
          jq --slurpfile cli nono/docs/docs.json \
             --slurpfile py nono-py/docs/docs.json \
             --slurpfile ts nono-ts/docs/docs.json \
             '
             ($cli[0].navigation.groups) as $cli_groups |
             ($py[0].navigation.groups) as $py_groups |
             ($ts[0].navigation.groups) as $ts_groups |
             .navigation.tabs |= map(
               if .tab == "CLI" then .groups = $cli_groups
               elif .tab == "Python" then .groups = $py_groups
               elif .tab == "TypeScript" then .groups = $ts_groups
               else .
               end
             )
             ' output/docs.json > output/docs.json.tmp && mv output/docs.json.tmp output/docs.json

          echo "Merged docs.json:"
          cat output/docs.json | jq '.navigation.tabs[] | .tab, (.groups | length)'

          echo "Aggregated docs structure:"
          find output -type f -name "*.mdx" | sort

      - name: Push to docs branch
        run: |
          cd base
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Fetch all branches
          git fetch origin

          # Create or switch to docs branch
          if git show-ref --verify --quiet refs/remotes/origin/docs; then
            git checkout -B docs origin/docs
          else
            git checkout --orphan docs
            git rm -rf . 2>/dev/null || true
          fi

          # Remove old content (except .git)
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +

          # Copy aggregated content
          cp -r ../output/* .

          # Commit and push
          git add -A
          git diff --staged --quiet || git commit -m "Aggregate docs from sub-repos"
          git push origin docs --force
